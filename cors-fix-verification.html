<!DOCTYPE html>
<html>
<head>
    <title>LiveSync CORS Fix Verification</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 15px; margin: 5px; }
        #results { max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 10px; }
    </style>
</head>
<body>
    <h1>LiveSync CORS Fix Verification</h1>
    <p>This test verifies that the CORS fix allows native fetch API to work with Obsidian LiveSync.</p>
    
    <div class="test-section">
        <h2>Test 1: Desktop Obsidian (app://obsidian.md)</h2>
        <button onclick="testDesktopObsidian()">Test Desktop Origin</button>
        <div id="desktop-results"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Mobile iOS (capacitor://localhost)</h2>
        <button onclick="testMobileObsidian()">Test Mobile Origin</button>
        <div id="mobile-results"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Native Fetch vs API Comparison</h2>
        <button onclick="testNativeFetch()">Test Native Fetch</button>
        <div id="fetch-results"></div>
    </div>

    <div id="results"></div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const className = type === 'success' ? 'success' : (type === 'error' ? 'error' : 'info');
            results.innerHTML += `<p class="${className}">[${new Date().toLocaleTimeString()}] ${message}</p>`;
            results.scrollTop = results.scrollHeight;
        }

        async function testWithOrigin(origin, sectionId) {
            const section = document.getElementById(sectionId);
            section.innerHTML = '<p>Testing...</p>';
            
            try {
                // Test the actual LiveSync scenario
                const response = await fetch('https://nuc-01-debian.emerald-wage.ts.net:3880/', {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Origin': origin,
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                section.innerHTML = `
                    <p class="success">✅ SUCCESS</p>
                    <p>Status: ${response.status}</p>
                    <p>Headers: Access-Control-Allow-Origin: ${response.headers.get('Access-Control-Allow-Origin')}</p>
                    <p>Response: ${JSON.stringify(data, null, 2)}</p>
                `;
                log(`SUCCESS: ${origin} - Native fetch works!`, 'success');
                
            } catch (error) {
                section.innerHTML = `
                    <p class="error">❌ FAILED</p>
                    <p>Error: ${error.message}</p>
                `;
                log(`ERROR: ${origin} - ${error.message}`, 'error');
            }
        }

        async function testDesktopObsidian() {
            await testWithOrigin('app://obsidian.md', 'desktop-results');
        }

        async function testMobileObsidian() {
            await testWithOrigin('capacitor://localhost', 'mobile-results');
        }

        async function testNativeFetch() {
            const section = document.getElementById('fetch-results');
            section.innerHTML = '<p>Testing native fetch capabilities...</p>';
            
            log('Starting native fetch test...', 'info');
            
            try {
                // Test 1: Basic connectivity
                const response1 = await fetch('https://nuc-01-debian.emerald-wage.ts.net:3880/', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                log(`Basic fetch: ${response1.status} OK`, 'success');
                
                // Test 2: With proper headers (simulating LiveSync)
                const response2 = await fetch('https://nuc-01-debian.emerald-wage.ts.net:3880/', {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data2 = await response2.json();
                
                section.innerHTML = `
                    <p class="success">✅ Native fetch working correctly!</p>
                    <p>Status: ${response2.status}</p>
                    <p>CORS Origin: ${response2.headers.get('Access-Control-Allow-Origin') || 'Not set (wildcard allowed)'}</p>
                    <p>CORS Credentials: ${response2.headers.get('Access-Control-Allow-Credentials')}</p>
                    <p>Response: ${JSON.stringify(data2, null, 2)}</p>
                `;
                
                log('Native fetch test PASSED - LiveSync should work now!', 'success');
                
            } catch (error) {
                section.innerHTML = `
                    <p class="error">❌ Native fetch still failing</p>
                    <p>Error: ${error.message}</p>
                `;
                log(`Native fetch test FAILED: ${error.message}`, 'error');
            }
        }

        // Auto-run tests on load
        window.onload = function() {
            log('CORS Fix Verification Test Started', 'info');
            log('This test verifies the fix for: "Native fetch API failing despite successful API calls"', 'info');
        };
    </script>
</body>
</html>